version: '3.8'

services:
  cribl:
    image: cribl/cribl:latest
    container_name: cribl
    restart: unless-stopped
    environment:
      - CRIB_DIST_MODE=single
      - HTTP_PROXY=http://mitmproxy:8080
      - HTTPS_PROXY=http://mitmproxy:8080
      - NODE_EXTRA_CA_CERTS=/etc/ssl/certs/mitmproxy-ca.pem
    volumes:
      - cribl_config:/opt/cribl/config-volume
      - cribl_local:/opt/cribl/local
      - ./certs/mitmproxy-ca-cert.pem:/etc/ssl/certs/mitmproxy-ca.pem:ro
    ports:
      - "9000:9000"   # UI
      - "10001:10001" # TCP JSON Input
      - "9514:9514/tcp" # Syslog TCP
      - "9514:9514/udp" # Syslog UDP
    networks:
      - obs_net
    depends_on:
      - mitmproxy

  mitmproxy:
    image: mitmproxy/mitmproxy:latest
    container_name: mitmproxy
    command: mitmdump -s /scripts/proxy-addon.py --set block_global=false
    volumes:
      - ./proxy-addon.py:/scripts/proxy-addon.py:ro
      - ./certs:/home/mitmproxy/.mitmproxy
      - ./logs:/home/mitmproxy/logs
    ports:
      - "8080:8080"   # Proxy port
    networks:
      - obs_net

networks:
  obs_net:
    driver: bridge

volumes:
  cribl_config:
  cribl_local:
